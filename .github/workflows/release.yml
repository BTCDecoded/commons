name: Create Unified Release

on:
  workflow_call:
    inputs:
      version_tag:
        description: 'Version tag for release (e.g., v0.1.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag for release (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  release:
    name: Create Release ${{ inputs.version_tag }}
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - name: Checkout commons
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/commons
          path: commons
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Fix corrupted cargo dependencies
        run: |
          # Update cargo to latest version
          rustup update cargo || true
          # Remove corrupted crates (cc, openssl-sys, and any other corrupted ones)
          find ~/.cargo/registry -path "*/cc-1.2.41*" -type d -exec rm -rf {} + 2>/dev/null || true
          find ~/.cargo/registry -path "*/cc-1.2.46*" -type d -exec rm -rf {} + 2>/dev/null || true
          find ~/.cargo/registry -path "*/openssl-sys-0.9.110*" -type d -exec rm -rf {} + 2>/dev/null || true
          # Clean cargo registry cache completely to force fresh downloads
          rm -rf ~/.cargo/registry/cache/* 2>/dev/null || true
          rm -rf ~/.cargo/git/db/* 2>/dev/null || true
          # Clean all build artifacts
          cargo clean || true
      
      - name: Checkout all repos at version
        run: |
          chmod +x commons/scripts/*.sh
          commons/scripts/setup-build-env.sh ${{ inputs.version_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
      
      - name: Build all repositories
        run: |
          commons/build.sh --mode release
        env:
          PARENT_DIR: ${{ github.workspace }}
      
      - name: Run tests
        run: |
          cd ${{ github.workspace }}
          for repo in bllvm-consensus bllvm-protocol bllvm-node bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "Running tests in $repo..."
              cd "$repo"
              cargo test --release --all-features || {
                echo "Tests failed in $repo"
                exit 1
              }
              cd ..
            fi
          done
        env:
          PARENT_DIR: ${{ github.workspace }}
      
      - name: Collect artifacts
        run: |
          commons/scripts/collect-artifacts.sh
      
      - name: Create release package
        run: |
          commons/scripts/create-release.sh ${{ inputs.version_tag }}
      
      - name: Verify versions
        run: |
          commons/scripts/verify-versions.sh
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version_tag }}
          name: BTCDecoded ${{ inputs.version_tag }}
          body_path: commons/artifacts/RELEASE_NOTES.md
          files: |
            commons/artifacts/*.tar.gz
            commons/artifacts/*.zip
            commons/artifacts/SHA256SUMS
          draft: false
          prerelease: ${{ contains(inputs.version_tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

