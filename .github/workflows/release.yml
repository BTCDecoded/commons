name: Create Unified Release

on:
  workflow_call:
    inputs:
      version_tag:
        description: 'Version tag for release (e.g., v0.1.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag for release (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  release:
    name: Create Release ${{ inputs.version_tag }}
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    steps:
      - name: Checkout commons
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/commons
          path: commons
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Check for performance tools and configure environment
        run: |
          echo "Checking for performance optimization tools..."
          RUSTFLAGS_BASE="-C debuginfo=0"
          if command -v mold &> /dev/null; then
            echo "✅ mold linker found"
            echo "RUSTFLAGS=${RUSTFLAGS_BASE} -C link-arg=-fuse-ld=mold" >> $GITHUB_ENV
          else
            echo "⚠️  mold linker not found (install for faster linking)"
            echo "RUSTFLAGS=${RUSTFLAGS_BASE}" >> $GITHUB_ENV
          fi
          if command -v ccache &> /dev/null; then
            echo "✅ ccache found"
            echo "CC=ccache gcc" >> $GITHUB_ENV
            echo "CXX=ccache g++" >> $GITHUB_ENV
          else
            echo "⚠️  ccache not found (install for faster C dependency builds)"
          fi
      
      - name: Fix corrupted cargo dependencies and config
        run: |
          # Update rustup and toolchain (cargo comes with the toolchain)
          rustup update stable || true
          # CRITICAL: Unset CARGO_BUILD_JOBS if it's 0 (cargo rejects this)
          if [ "${CARGO_BUILD_JOBS:-}" = "0" ]; then
            echo "⚠️  CARGO_BUILD_JOBS is set to 0, unsetting it..."
            unset CARGO_BUILD_JOBS
            # Remove from GITHUB_ENV if it exists
            if [ -f "$GITHUB_ENV" ]; then
              sed -i '/^CARGO_BUILD_JOBS=/d' "$GITHUB_ENV" || true
            fi
          fi
          # Remove jobs=0 from config files (cargo rejects this)
          # Check for various formats: jobs=0, jobs = 0, jobs= 0, jobs =0
          if [ -f ~/.cargo/config.toml ]; then
            if grep -qE "jobs\s*=\s*0" ~/.cargo/config.toml 2>/dev/null; then
              echo "⚠️  Found jobs=0 in ~/.cargo/config.toml, removing it..."
              sed -i -E '/jobs\s*=\s*0/d' ~/.cargo/config.toml || true
            fi
          fi
          # Remove jobs=0 from workspace config files
          find . -name "config.toml" -path "*/.cargo/*" 2>/dev/null | while read file; do
            if grep -qE "jobs\s*=\s*0" "$file" 2>/dev/null; then
              echo "⚠️  Found jobs=0 in $file, removing it..."
              sed -i -E '/jobs\s*=\s*0/d' "$file" || true
            fi
          done
          # Remove incremental from config files when using sccache
          if [ "${RUSTC_WRAPPER:-}" = "sccache" ]; then
            if [ -f ~/.cargo/config.toml ]; then
              if grep -q "incremental" ~/.cargo/config.toml 2>/dev/null; then
                echo "⚠️  Removing incremental from ~/.cargo/config.toml (sccache requirement)"
                sed -i '/\[build\]/,/^\[/ { /incremental/d; }' ~/.cargo/config.toml || true
                sed -i '/^incremental/d' ~/.cargo/config.toml || true
              fi
            fi
            find . -name "config.toml" -path "*/.cargo/*" 2>/dev/null | while read file; do
              if grep -q "incremental" "$file" 2>/dev/null; then
                echo "⚠️  Removing incremental from $file (sccache requirement)"
                sed -i '/incremental/d' "$file" || true
              fi
            done
            unset CARGO_INCREMENTAL || true
          fi
          # Completely clear cargo registry to fix corrupted crates
          echo "Cleaning corrupted cargo registry..."
          rm -rf ~/.cargo/registry/src/* 2>/dev/null || true
          rm -rf ~/.cargo/registry/cache/* 2>/dev/null || true
          rm -rf ~/.cargo/git/db/* 2>/dev/null || true
          rm -rf ~/.cargo/git/checkouts/* 2>/dev/null || true
          echo "Cargo registry cleaned, dependencies will be re-downloaded"
      
      - name: Checkout all repos at version
        run: |
          chmod +x commons/scripts/*.sh
          commons/scripts/setup-build-env.sh ${{ inputs.version_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          PARENT_DIR: ${{ github.workspace }}
      
      - name: Install Windows target for cross-compilation
        run: |
          rustup target add x86_64-pc-windows-msvc
          # Install mingw-w64 for linking (required for cross-compilation)
          # Note: This may require additional system packages on the runner
          echo "Windows target installed"
      
      - name: Build all repositories (Linux)
        run: |
          # CRITICAL: Unset CARGO_BUILD_JOBS if it's 0 (cargo rejects this)
          if [ "${CARGO_BUILD_JOBS:-}" = "0" ]; then
            echo "⚠️  CARGO_BUILD_JOBS is set to 0, unsetting it..."
            unset CARGO_BUILD_JOBS
          fi
          commons/build.sh --mode release
        env:
          PARENT_DIR: ${{ github.workspace }}
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Build all repositories (Windows cross-compile)
        run: |
          cd ${{ github.workspace }}
          for repo in bllvm bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "Building $repo for Windows..."
              cd "$repo"
              # Omit --jobs flag to use all available CPU cores
              cargo build --release --target x86_64-pc-windows-msvc --all-features || {
                echo "Windows build failed for $repo (continuing...)"
              }
              cd ..
            fi
          done
        env:
          PARENT_DIR: ${{ github.workspace }}
          CARGO_INCREMENTAL: "1"
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Run tests (skip doctests for Phase 1 prerelease)
        run: |
          cd ${{ github.workspace }}
          for repo in bllvm-consensus bllvm-protocol bllvm-node bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "Running tests in $repo (skipping doctests and CI-problematic tests)..."
              cd "$repo"
              # Skip doctests for Phase 1 prerelease
              # --lib --bins --tests excludes --doc (doctests)
              # Skip tests that hang in CI environment
              # Use timeout command to prevent hanging tests (30 min total per repo)
              # Run tests with single thread to avoid resource contention
              # Skip tests that hang in CI - use filter to exclude them
              # The test was removed but --skip is harmless if test doesn't exist
              timeout 1800 cargo test --release --all-features --lib --bins --tests -- --test-threads=1 --skip test_handle_incoming_wire_tcp_enqueues_pkgtxn 2>&1 | tee /tmp/test_output.log || {
                EXIT_CODE=$?
                if [ $EXIT_CODE -eq 124 ]; then
                  echo "Tests timed out in $repo (exceeded 30 minutes)"
                  echo "Last 50 lines of test output:"
                  tail -50 /tmp/test_output.log || true
                else
                  echo "Tests failed in $repo"
                  echo "Last 50 lines of test output:"
                  tail -50 /tmp/test_output.log || true
                fi
                exit 1
              }
              cd ..
            fi
          done
        env:
          PARENT_DIR: ${{ github.workspace }}
          CI: true
          GITHUB_ACTIONS: true
      
      - name: Collect artifacts
        run: |
          commons/scripts/collect-artifacts.sh linux-x86_64
          commons/scripts/collect-artifacts.sh windows-x86_64
      
      - name: Create release package
        run: |
          commons/scripts/create-release.sh ${{ inputs.version_tag }}
      
      - name: Verify versions
        run: |
          commons/scripts/verify-versions.sh
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version_tag }}
          name: BTCDecoded ${{ inputs.version_tag }}
          body_path: commons/artifacts/RELEASE_NOTES.md
          files: |
            commons/artifacts/*.tar.gz
            commons/artifacts/*.zip
            commons/artifacts/SHA256SUMS-*
          draft: false
          prerelease: ${{ contains(inputs.version_tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

