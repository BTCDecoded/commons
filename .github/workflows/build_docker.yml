name: Build Docker Image (Reusable)

on:
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
      context:
        required: false
        type: string
        default: .
      image_name:
        required: false
        type: string
        default: governance-app
      push:
        required: false
        type: boolean
        default: false
      ref:
        required: true
        type: string
      tag:
        required: true
        type: string

jobs:
  docker:
    # Prefer runners with docker label, fallback to basic (setup-docker can install)
    runs-on: self-hosted,linux,x64,docker
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ inputs.repo }}
          ref: ${{ inputs.ref }}

      - name: Set up QEMU (optional)
        if: ${{ inputs.push }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry (optional)
        if: ${{ inputs.push }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          push: ${{ inputs.push }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository_owner }}/${{ inputs.image_name }}:${{ inputs.tag }}
